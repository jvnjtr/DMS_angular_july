<!DOCTYPE html>
<html>

<head>
  <title>OfficeJs | Demos </title>
  <meta charset="utf-8">
  <link href="./layout/styles/layout.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="./include/jquery_ui/themes/start/jquery-ui.min.css">
  <script src="../viewer_config.js"></script>
  <script src="./include/jquery/jquery-1.12.4.min.js"></script>
  <script src="./include/jquery_ui/jquery-ui.min.js"></script>
  <!-- ################################ For files reder ###############################-->
  <!--PDF-->
  <link rel="stylesheet" href="./include/pdf/pdf.viewer.css">
  <script src="./include/pdf/pdf.js"></script>
  <!--Docs-->
  <script src="./include/docx/jszip-utils.js"></script>
  <script src="./include/docx/mammoth.browser.min.js"></script>
  <!--PPTX-->
  <link rel="stylesheet" href="./include/PPTXjs/css/pptxjs.css">
  <link rel="stylesheet" href="./include/PPTXjs/css/nv.d3.min.css">
  <script type="text/javascript" src="./include/PPTXjs/js/filereader.js"></script>
  <script type="text/javascript" src="./include/PPTXjs/js/d3.min.js"></script>
  <script type="text/javascript" src="./include/PPTXjs/js/nv.d3.min.js"></script>
  <script type="text/javascript" src="./include/PPTXjs/js/pptxjs.js"></script>
  <script type="text/javascript" src="./include/PPTXjs/js/divs2slides.js"></script>
  <!--All Spreadsheet -->
  <!-- <link rel="stylesheet" href="./include/SheetJS/handsontable.full.min.css">
  <script type="text/javascript" src="./include/SheetJS/handsontable.full.min.js"></script>-->

  <link href="./excel/xspreadsheet.css" rel="stylesheet">
  <script type="text/javascript" src="./excel/xspreadsheet.js"></script>

  <script type="text/javascript" src="./include/SheetJS/xlsx.full.min.js"></script>
  <!--Image viewer-->
  <link rel="stylesheet" href="./include/verySimpleImageViewer/css/jquery.verySimpleImageViewer.css">
  <script type="text/javascript" src="./include/verySimpleImageViewer/js/jquery.verySimpleImageViewer.js"></script>
  <!--officeToHtml-->
  <script src="./include/officeToHtml/officeToHtml.js"></script>
  <link rel="stylesheet" href="./include/officeToHtml/officeToHtml.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>


  <!-- <link href="./flora_editor/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="./flora_editor/css/froala_editor.min.css" rel="stylesheet" type="text/css"> -->

  <!-- <script src="./flora_editor/js/froala_editor.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
		<link href="http://netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css" rel="stylesheet" />
		<link href="demo1/css/style.css" rel="stylesheet" />
</head>

<body id="top">
  <div class="wrapper row1">
  </div>
  <div class="wrapper row3">
    <main class="hoc container clear">
      <!-- main body -->
      <!-- <div class="sidebar one_quarter first">
        <nav class="sdb_holder">
          <ul>
            <li class="active"><a href="demos.html">Demos - Main</a></li>
            <ul>
              <li><a href="#" id="demo_1" class="demos" data-file="demo.docx">Demo1 - docx</a></li>
              <li><a href="#" id="demo_2" class="demos" data-file="demo.pptx">Demo2 - pptx</a></li>
              <li><a href="#" id="demo_3" class="demos" data-file="demo.xlsx">Demo3 - xlsx</a></li>
              <li><a href="#" id="demo_4" class="demos" data-file="demo.pdf">Demo4 - pdf</a></li>
              <li><a href="#" id="demo_5" class="demos" data-file="demo.jpg">Demo4 - image</a></li>
              <li><a href="#" id="demo_input" class="demos" data-file="">Demo5 - Input</a></li>
            </ul>
          </ul>
        </nav>
      </div> -->
      <!-- ################################################################################################ -->
      <div class="content three_quarter">
        <!-- <div class="box bg-light clear">

          <p id="file_p" style="display:none;">File: <a href="#" id="a_file"></a><input type="file" id="select_file" />
          </p>
        </div> -->
        <p id="resolte-text" style="display:none">Resolte:</p>
        <!--<div id="resolte-contaniner" style="display:none;"></div>-->
        <div style="overflow: hidden;width: 100% ">
          
          <!-- <div class="jumbotron"> -->
            <div class="pull-right"></div>
            
            <div id="alerts"></div>
            <div style="display: none;" class="btn-toolbar"  data-role="editor-toolbar" data-target="#resolte-contaniner" id="resolte-toolbar">
              <div class="btn-group">
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" title="Font Size"><i class="fa fa-text-height"></i>&nbsp;<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a data-edit="fontSize 5" class="fs-Five">Huge</a></li>
                  <li><a data-edit="fontSize 3" class="fs-Three">Normal</a></li>
                  <li><a data-edit="fontSize 1" class="fs-One">Small</a></li>
                </ul>
              </div>
              <div class="btn-group">
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" title="Text Highlight Color"><i class="fa fa-paint-brush"></i>&nbsp;<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <p>&nbsp;&nbsp;&nbsp;Text Highlight Color:</p>
                              <li><a data-edit="backColor #00FFFF">Blue</a></li>
                  <li><a data-edit="backColor #00FF00">Green</a></li>
                  <li><a data-edit="backColor #FF7F00">Orange</a></li>
                  <li><a data-edit="backColor #FF0000">Red</a></li>
                  <li><a data-edit="backColor #FFFF00">Yellow</a></li>
                </ul>
              </div>
              <div class="btn-group">
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" title="Font Color"><i class="fa fa-font"></i>&nbsp;<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <p>&nbsp;&nbsp;&nbsp;Font Color:</p>
                  <li><a data-edit="foreColor #000000">Black</a></li>
                              <li><a data-edit="foreColor #0000FF">Blue</a></li>
                              <li><a data-edit="foreColor #30AD23">Green</a></li>
                  <li><a data-edit="foreColor #FF7F00">Orange</a></li>
                  <li><a data-edit="foreColor #FF0000">Red</a></li>
                  <li><a data-edit="foreColor #FFFF00">Yellow</a></li>
                </ul>
              </div>
              <div class="btn-group">
                <a class="btn btn-default" data-edit="bold" title="Bold (Ctrl/Cmd+B)"><i class="fa fa-bold"></i></a>
                <a class="btn btn-default" data-edit="italic" title="Italic (Ctrl/Cmd+I)"><i class="fa fa-italic"></i></a>
                <a class="btn btn-default" data-edit="strikethrough" title="Strikethrough"><i class="fa fa-strikethrough"></i></a>
                <a class="btn btn-default" data-edit="underline" title="Underline (Ctrl/Cmd+U)"><i class="fa fa-underline"></i></a>
              </div>
              <div class="btn-group">
                <a class="btn btn-default" data-edit="insertunorderedlist" title="Bullet list"><i class="fa fa-list-ul"></i></a>
                <a class="btn btn-default" data-edit="insertorderedlist" title="Number list"><i class="fa fa-list-ol"></i></a>
                <a class="btn btn-default" data-edit="outdent" title="Reduce indent (Shift+Tab)"><i class="fa fa-outdent"></i></a>
                <a class="btn btn-default" data-edit="indent" title="Indent (Tab)"><i class="fa fa-indent"></i></a>
              </div>
              <div class="btn-group">
                <a class="btn btn-default" data-edit="justifyleft" title="Align Left (Ctrl/Cmd+L)"><i class="fa fa-align-left"></i></a>
                <a class="btn btn-default" data-edit="justifycenter" title="Center (Ctrl/Cmd+E)"><i class="fa fa-align-center"></i></a>
                <a class="btn btn-default" data-edit="justifyright" title="Align Right (Ctrl/Cmd+R)"><i class="fa fa-align-right"></i></a>
                <a class="btn btn-default" data-edit="justifyfull" title="Justify (Ctrl/Cmd+J)"><i class="fa fa-align-justify"></i></a>
              </div>
              <div class="btn-group">
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" title="Hyperlink"><i class="fa fa-link"></i></a>
                <div class="dropdown-menu input-append">
                  <input placeholder="URL" type="text" data-edit="createLink" />
                  <button class="btn" type="button">Add</button>
                </div>
              </div>
              <div class="btn-group">
                <a class="btn btn-default" data-edit="unlink" title="Remove Hyperlink"><i class="fa fa-unlink"></i></a>
                <span class="btn btn-default" title="Insert picture (or just drag & drop)" id="pictureBtn"> <i class="fa fa-picture-o"></i>
                  <input class="imgUpload" type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" />
                </span>
              </div>
              <div class="btn-group">
                <a class="btn btn-default" data-edit="undo" title="Undo (Ctrl/Cmd+Z)"><i class="fa fa-undo"></i></a>
                <a class="btn btn-default" data-edit="redo" title="Redo (Ctrl/Cmd+Y)"><i class="fa fa-repeat"></i></a>
                <a class="btn btn-default" data-edit="html" title="Clear Formatting"><i class='glyphicon glyphicon-pencil'></i></a>
              </div>
			     </div>
            <div id="resolte-contaniner" style="width: 100%; height: auto; overflow: auto;"></div>
          <!-- </div> -->
        </div>
        <button id="btn-export" class="btn btn-primary btn-sm" style="display:none;position: absolute;
    top: 12px;
    right: 10px;
    z-index: 999; padding: 0.3rem 0.5rem;
    text-transform: uppercase;
    border: 1px solid transparent;
    font-size: 14px;
    border-radius: 4px;cursor:pointer;background-color: green;">
          Save
        </button>
        <script>
          var fileType;
          (function ($) {
            $(".demos").on("click", function (e) {
              e.preventDefault();
              $(".sdb_holder li").removeClass("active");
              $(this).parent().addClass("active");
              var id = $(this).attr("id");
              $("#head-name").html($(this).html());
              $("#description").hide();
              $("#resolte-contaniner").html("");
              $("#resolte-contaniner").show();
              $("#resolte-text").show();
              if (id != "demo_input") {
                $("#select_file").hide();
                var file_path = "files\\" + $(this).data("file");
                $("#a_file").html($(this).data("file")).attr("href", file_path);
                $("#a_file").show();
                $("#file_p").show();

                $("#resolte-contaniner").officeToHtml({
                  url: file_path,
                  pdfSetting: {
                    setLang: "",
                    setLangFilesPath: "" /*"include/pdf/lang/locale" - relative to app path*/
                  }
                });
              } else {
                $("#select_file").show();
                $("#file_p").show();
                $("#a_file").hide();
                $("#resolte-contaniner").officeToHtml({
                  inputObjId: "select_file",
                  pdfSetting: {
                    setLang: "",
                    setLangFilesPath: "" /*"include/pdf/lang/locale" - relative to app path*/
                  }
                });
              }
            });
          }(jQuery));









          // jQuery html to word plugin function
          //if (typeof jQuery !== "undefined" && typeof saveAs !== "undefined") {
          (function ($) {
            $.fn.wordExport = function (fileName) {
              //now ask the user about whether to save or not
              Swal.fire({
                title: 'Proceed to save the changes?',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Save',
                denyButtonText: `Don't save`,
              }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                  //call the api
                  fileName = typeof fileName !== 'undefined' ? fileName : "jQuery-Word-Export";
                  var static = {
                    mhtml: {
                      top: "Mime-Version: 1.0\nContent-Base: " + location.href + "\nContent-Type: Multipart/related; boundary=\"NEXT.ITEM-BOUNDARY\";type=\"text/html\"\n\n--NEXT.ITEM-BOUNDARY\nContent-Type: text/html; charset=\"utf-8\"\nContent-Location: " + location.href + "\n\n<!DOCTYPE html>\n<html>\n_html_</html>",
                      head: "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<style>\n_styles_\n</style>\n</head>\n",
                      body: "<body>_body_</body>"
                    }
                  };
                  var options = {
                    maxWidth: 624
                  };
                  // Clone selected element before manipulating it
                  var markup = $(this).clone();
                  // console.log(markup);
                  // Remove hidden elements from the output
                  markup.each(function () {
                    var self = $(this);
                    if (self.is(':hidden'))
                      self.remove();
                  });

                  // Embed all images using Data URLs
                  var images = Array();
                  var img = markup.find('img');
                  for (var i = 0; i < img.length; i++) {
                    // Calculate dimensions of output image
                    var w = Math.min(img[i].width, options.maxWidth);
                    var h = img[i].height * (w / img[i].width);
                    // Create canvas for converting image to data URL
                    var canvas = document.createElement("CANVAS");
                    canvas.width = w;
                    canvas.height = h;
                    // Draw image to canvas
                    var context = canvas.getContext('2d');
                    context.drawImage(img[i], 0, 0, w, h);
                    // Get data URL encoding of image
                    var uri = canvas.toDataURL("image/png");
                    $(img[i]).attr("src", img[i].src);
                    img[i].width = w;
                    img[i].height = h;
                    // Save encoded image to array
                    images[i] = {
                      type: uri.substring(uri.indexOf(":") + 1, uri.indexOf(";")),
                      encoding: uri.substring(uri.indexOf(";") + 1, uri.indexOf(",")),
                      location: $(img[i]).attr("src"),
                      data: uri.substring(uri.indexOf(",") + 1)
                    };
                  }

                  // Prepare bottom of mhtml file with image data
                  var mhtmlBottom = "\n";
                  for (var i = 0; i < images.length; i++) {
                    mhtmlBottom += "--NEXT.ITEM-BOUNDARY\n";
                    mhtmlBottom += "Content-Location: " + images[i].location + "\n";
                    mhtmlBottom += "Content-Type: " + images[i].type + "\n";
                    mhtmlBottom += "Content-Transfer-Encoding: " + images[i].encoding + "\n\n";
                    mhtmlBottom += images[i].data + "\n\n";
                  }
                  mhtmlBottom += "--NEXT.ITEM-BOUNDARY--";

                  //TODO: load css from included stylesheet
                  var styles = "";

                  // Aggregate parts of the file together
                  var fileContent = static.mhtml.top.replace("_html_", static.mhtml.head.replace("_styles_", styles) + static.mhtml.body.replace("_body_", markup.html())) + mhtmlBottom;
        
                  // console.log(markup.html());
                  // return false;
                  // Create a Blob with the file contents
                  var blob = new Blob([fileContent], {
                    type: "application/msword;charset=utf-8"
                  });

                  // Create a Blob with the file contents
                  var formData = new FormData()
                  formData.append('source', blob)

                  var doc = new DOMParser().parseFromString(markup.html(), 'text/html');
                  var result = new XMLSerializer().serializeToString(doc);
                  //console.log(result);
                  // return false;
                  // var result = '<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body><p></p><p></p><p></p><p></p><p></p><p></p><br /><ol><li><div style="color:#30ad23;"><b>kjdshkshkshkfhs</b></div></li></ol></body></html>';
                  
                  // saveAs(blob, fileName + ".doc");
                  // return false;
                  // console.log(blob)
                  //export file to server and save it
                  var fileId;
                  var token;
                  const queryString = window.location.search;
                  // console.log(queryString);
                  const urlParams = new URLSearchParams(queryString);
                  fileId = urlParams.get("fileId");
                  // console.log(fileId);
                  token = urlParams.get("token");
                  // var fileTypename = blob.type;
                  // console.log(fileTypename);
                  var fileTypearr = 'doc';
                  // var fileTypearr = fileTypename.split("/");
                  var fd = new FormData(); // To carry on your data
                  fd.append("file", result);
                  fd.append("fileId", fileId);
                  fd.append("fileType", fileTypearr);
                  $.ajax({
                    type: "POST",
                    headers: { Authorization: "bearer " + token },
                    url: commonAnnotationUrl,
                    processData: false,
                    contentType: false,
                    data: fd,
                    success: function (response) {
                      if (response.status == 200) {
                        Swal.fire({
                          text: "File Saved Successfully",
                          icon: "success",
                          confirmButtonColor: "#3085d6",
                          confirmButtonText: "ok",
                        }).then((result) => {
                          if (result.isConfirmed) {
                            window.location.reload;
                          }
                        });
                      } else {
                        Swal.fire({
                          title: 'Oops...',
                          text: 'Something went wrong!',
                          icon: "error",
                          confirmButtonColor: "#3085d6",
                          confirmButtonText: "ok",
                        }).then((result) => {
                          if (result.isConfirmed) {
                            window.location.reload;
                          }
                        });
                      }


                    },
                  });
                  //export file to server and save it
                  //call the api
                } else if (result.isDenied) {
                  Swal.fire('Changes are not saved', '', 'info')
                }
              })
              //now ask the user about whether to save or not

            };
          })(jQuery);
          // } else {
          //     if (typeof jQuery === "undefined") {
          //         console.error("jQuery Word Export: missing dependency (jQuery)");
          //     }
          //     if (typeof saveAs === "undefined") {
          //         console.error("jQuery Word Export: missing dependency (FileSaver.js)");
          //     }
          // }


          jQuery(document).ready(function ($) {
            $("#btn-export").click(function (event) {
              $("#resolte-contaniner").wordExport();
            });
            //new Ajax.Request
            //get the file from the database based on the file id and token
            var filePath;
            var fileId;
            var token;
            var excelData;
            var logId;
            var type;
            const queryString = window.location.search;
            // console.log(queryString);
            const urlParams = new URLSearchParams(queryString);
            fileId = urlParams.get("fileId");
            // console.log(fileId);
            token = urlParams.get("token");
            var logId1 = urlParams.get("logId");
            var type1 = urlParams.get("type");
            if(type1 > 0){
              type=type1;
            }
            if(logId1 > 0){
              logId=logId1;
            }else{
               logId=0;
            }
            // console.log(token);
            if (fileId && fileId > 0) {
              var data = {
                fileId: fileId,
                logId: logId,
              };
              $.ajax({
                type: "POST",
                headers: { Authorization: "bearer " + token },
                url: commonDecryptUrl,
                data: data,
                async: false,
                dataType: "json",
                success: function (response) {
                  console.log(response);
                  if (response.status == 200) {
                    // $('#pdfloader').hide();
                    // $('#loader').addClass('d-none');
                    // $('.loader loader2').addClass('.d-none');
                    if (response.result.fileData != null) {
                      // console.log('lkdsjlsdks');
                      excelData = response.result.fileData;
                      $('#btn-export').hide();
                    }
                    filePath = response.result.filePath;
                    // console.log(filePath);
                    fileType = response.result.fileExtension;

                    if ((fileType == 'docx') || (fileType == 'doc')) {
                      // $('#resolte-toolbar').hide();
                      if(type > 1){
                        $('#resolte-toolbar').show();
                        $('#btn-export').show();
                      }else{
                        $('#resolte-toolbar').hide();
                        $('#btn-export').hide();
                      }
                      

                    } else {
                      //alert(1);
                      $('#resolte-toolbar').hide();
                      $('#btn-export').hide();
                    }

                  } else {
                    //alert(2);
                    console.log("Error");
                  }
                },
              });
              //get the file from the database based on the file id and token
            } else {
              //alert(3)
              var newPath = urlParams.get("filePath");
              if (newPath) {
                filePath = newPath;
                $('#btn-export').hide();
              }
            }

            // var file_path = "files\\" + $(this).data("file");
            var file_path = filePath;
            $("#a_file").html($(this).data("file")).attr("href", file_path);
            $("#a_file").show();
            $("#file_p").show();

            $("#resolte-contaniner").officeToHtml({

              url: file_path,
              pdfSetting: {
                setLang: "",
                setLangFilesPath: "" /*"include/pdf/lang/locale" - relative to app path*/
              },
              excelData: excelData
            });
            //new Ajax.Request
          });










        </script>
      </div>
  </div>
  <!-- / main body -->
  <div class="clear"></div>
  </main>
  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="demo1/bower_components/jquery.hotkeys/jquery.hotkeys.js"></script>
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="demo1/bower_components/google-code-prettify/src/prettify.js"></script>
  <script src="demo1/src/bootstrap-wysiwyg.js"></script>
  <script>
    $(function()
    {
        function initToolbarBootstrapBindings()
        {
            var fonts = ['Serif', 'Sans', 'Arial', 'Arial Black', 'Courier', 
                'Courier New', 'Comic Sans MS', 'Helvetica', 'Impact', 'Lucida Grande', 'Lucida Sans', 'Tahoma', 'Times',
                'Times New Roman', 'Verdana'],
                fontTarget = $('[title=Font]').siblings('.dropdown-menu');
        
            $.each(fonts, function (idx, fontName)
            {
                fontTarget.append($('<li><a data-edit="fontName ' + fontName +'" style="font-family:\''+ fontName +'\'">'+fontName + '</a></li>'));
            });

            $('a[title]').tooltip({container:'body'});

          $('.dropdown-menu input').click(function() {return false;})
            .change(function ()
            {
              $(this).parent('.dropdown-menu').siblings('.dropdown-toggle').dropdown('toggle');
            }).keydown('esc', function ()
                {
                  this.value='';$(this).change();
                });

          $('[data-role=magic-overlay]').each(function ()
            { 
               var overlay = $(this), target = $(overlay.data('target')); 
              overlay.css('opacity', 0).css('position', 'absolute').offset(target.offset()).width(target.outerWidth()).height(target.outerHeight());
            });
        
            if ("onwebkitspeechchange"  in document.createElement("input")) 
            {
              var editorOffset = $('#resolte-contaniner').offset();
              //$('#voiceBtn').css('position','absolute').offset({top: editorOffset.top, left: editorOffset.left+$('#editor').innerWidth()-35});
            }

            else
            {
              $('#voiceBtn').hide();
        }
      };

    function showErrorAlert (reason, detail)
    {
      var msg='';
      if (reason==='unsupported-file-type')
      {
        msg = "Unsupported format " + detail;
      }
      else
      {
        console.log("error uploading file", reason, detail);
      }

      $('<div class="alert"> <button type="button" class="close" data-dismiss="alert">&times;</button>'+ 
        '<strong>File upload error</strong> '+msg+' </div>').prependTo('#alerts');
    };

      initToolbarBootstrapBindings();  
    $('#resolte-contaniner').wysiwyg({ fileUploadError: showErrorAlert} );

      window.prettyPrint && prettyPrint();
    });
  </script>
</body>

</html>